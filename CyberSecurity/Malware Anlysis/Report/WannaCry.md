# Intro 
WannaCry is the most famous `crypto-ransomware`. WannaCry used the famous `[Enternal Blue - CVE-2017-0144 Detail](https://en.wikipedia.org/wiki/EternalBlue)` vulnerability discovered by *National Security Agency (NSA)* stolen and made public by *Shadows Brokers*. This vulnerability target a bug in the packing handling of `SMBv1` protocol.


![[Pasted image 20250211230114.png]]

## Malware Composition

The `Ransomware.wannacry.exe` consist in the following components:

| Filename                | MD5                              | SHA1                                     | SHA-256                                                          | SHA-512                                                                                                                          | Full Path                             | File Size | File Version                             | Product Version | Extension |
| ----------------------- | -------------------------------- | ---------------------------------------- | ---------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------- | --------- | ---------------------------------------- | --------------- | --------- |
| Ransomware.wannacry.exe | db349b97c37d22f5ea1d1841e3c89eb4 | e889544aff85ffaf8b0d0da705105dee7c97fe26 | 24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c | 4550dd1787deb353ebd28363dd2cdccca861f6a5d9358120fa6aa23baa478b2a9eb43cef5e3f6426f708a0753491710ac05483fac4a046c26bec4234122434d5 | C:\Users\BusySec\Desktop\taskdl.exe   | 3.723.264 | 6.1.7600.16385 (win7_rtm.090713-1255)    | 6.1.7601.17514  | exe       |
| tasksche.exe            | 84c82835a5d21bbcf75a61706d8ab549 | 5ff465afaabcbf0150d1a3ab2c2e74f3a4426467 | ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa | 90723a50c20ba3643d625595fd6be8dcf88d70ff7f4b4719a88f055d5b3149a4231018ea30d375171507a147e59f73478c0c27948590794554d031e7d54b7244 | C:\Users\BusySec\Desktop\tasksche.exe | 3.514.368 | 6.1.7601.17514 (win7sp1_rtm.101119-1850) | 6.1.7601.17514  | exe       |
| taskse.exe              | 8495400f199ac77853c53b5a3f278f3e | be5d6279874da315e3080b06083757aad9b32c23 | 2ca2d550e603d74dedda03156023135b38da3630cb014e3d00b1263358c5f00d | 0669c524a295a049fa4629b26f89788b2a74e1840bcdc50e093a0bd40830dd1279c9597937301c0072db6ece70adee4ace67c3c8a4fb2db6deafd8f1e887abe4 | C:\Users\BusySec\Desktop\taskse.exe   | 20.480    | 6.1.7600.16385 (win7_rtm.090713-1255)    | 6.1.7600.16385  | exe       |
| taskdl.exe              | 4fef5e34143e646dbf9907c4374276f5 | 47a9ad4125b6bd7c55e4e7da251e23f089407b8f | 4a468603fdcb7a2eb5770705898cf9ef37aade532a7964642ecd705a74794b79 | 4550dd1787deb353ebd28363dd2cdccca861f6a5d9358120fa6aa23baa478b2a9eb43cef5e3f6426f708a0753491710ac05483fac4a046c26bec4234122434d5 | C:\Users\BusySec\Desktop\taskdl.exe   | 20.480    | 6.1.7600.16385 (win7_rtm.090713-1255)    | 6.1.7600.16385  | exe       |


TODO scrivere cosa fanno
- `Ransomware.wannacry.exe`: is a dropper with killwitch and worm capability
- `tasksche.exe`:
- `taskse.exe`:
- `taskdl.exe`:


# Static Analysis
**Binary Type:** 32-bit executable
**Packing:** Armadillo v1.71
**Detection Rate:** Flagged by **70/72** engines on VirusTotal at the time of analysis.
**Suspicious strings:**
- ` hxxp://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com`: This is the endpoint used during killsiwtch feature

- `C:\%s\qeriuwjhrf`: the path where `Ransomware.wannacry.exe` drop all exe file contained within.

- `CreateServiceA` & `StartServiceA`: Windows API used by `Ransomware.wannacry.exe` to create a *Windows Service*

- `CryptAcquireContextA` & `CryptGenRandom`: Windows API used by `Ransomware.wannacry.exe` to encrypt all files.

#### Virus Total records
[24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c](https://www.virustotal.com/gui/file/24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c)

### Architecture

The malware is written for 32-bit architecture
![[Pasted image 20250209170935.png]]


### IAT



The import address table (IAT) of WannaCry is:

| DLL Name     | Address1   | Address2   | Type     | Count | Category | Description                           |
| ------------ | ---------- | ---------- | -------- | ----- | -------- | ------------------------------------- |
| WS2_32.dll   | 0x0000A3C4 | 0x0000A144 | implicit | 13    | network  | Windows Socket Library                |
| iphlpapi.dll | 0x0000A3FC | 0x0000A17C | implicit | 2     | network  | IP Helper API                         |
| WININET.dll  | 0x0000A3B4 | 0x0000A134 | implicit | 3     | network  | Internet Extensions for Win32 Library |
| KERNEL32.dll | 0x0000A2B0 | 0x0000A030 | implicit | 32    | -        | Windows NT BASE API Client            |
| ADVAPI32.dll | 0x0000A280 | 0x0000A000 | implicit | 11    | -        | Advanced Windows 32 Base API          |
| MSVCP60.dll  | 0x0000A334 | 0x0000A0B4 | implicit | 2     | -        | Windows C Runtime Library             |
| MSVCRT.dll   | 0x0000A340 | 0x0000A0C0 | implicit | 28    | -        | Microsoft C Runtime Library           |




The `signature: executable, offset: 0x000320A4, size: 3514368 bytes` indicated that malware have inside of it another PE files.
![[Pasted image 20250212232122.png]]


we now that are ransomware infected there are `CryptGenRandom` `CryptAcquireContextA` methods of `ADVAPI32.dll` in the Import Address Table.
![[Pasted image 20250212201258.png]]


Analyzing the string i founded this path `C:\%s\qeriuwjhrf` where the `%s` will be replace by the program when executed.

With PE studio we see the malware have inside another 3 signature of the PE file, this are the possible name of then
![[Pasted image 20250212233719.png]]

I found a strange endpoint. Explore more of that in reverse engineering section.

`http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com`
![[Pasted image 20250209172055.png]]



### Reverse Engineering 
![[Pasted image 20250312143419.png]]

At a start up Wannacry call first the `[InternetOpenA](https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopena)` winApi to initialize `WinINet` function. After that the `[InternetOpenUrlA](https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopenurla)` will invoked this contact trought HTPP the strange endpoint founded during the string analysis `http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com`,
if this endpoint exists the InternetOpenUrlA return a true value.

#### KillSwitch Mode
The program is be written to close itself the InternetOpenUrlA return a true value. In a nutshell if the `http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com` endpoint exists Wannacry stop his execution.




# Dynamic Analysis

## Network Indicators

### kill Switch

#### Debugging Kill Switch
![[Pasted image 20250312125156.png]]
Step into this function and we can see is the killwicth feature 
![[Pasted image 20250312125420.png]]

Set `ZF` flag to 0 and interrupts its execution 
![[Pasted image 20250312125356.png]]

In this case i have activated the `InetSim` on my `Remnux` machine.

Dns Request 
`www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com`

![[Pasted image 20250211221550.png]]

Http Request respond with 200

![[Pasted image 20250211221756.png]]

In this case wannaCry doesn't execute its malicious activities and close itself. Thi is `killswitch` mechanism founded in the RE section.


### Propagation

Wannacry is `ransomware` but his have the `worm` ability.
This means its able to propagate itself using the victim network. In this case Wannacry try to propagate itself targeting the `445` port (SMB port).
![[Pasted image 20250213001927.png]]

## Host base indicator

After execution of `Ransomware.wannacry.exe` that create a windows service called `xjskenheabcsyb820` to create a persistence in the process.
![[Pasted image 20250312144637.png]]

It's possible verify that with service query:

```powershell
sc qc "xjskenheabcsyb820"
```


![[Pasted image 20250217233316.png]]

This service start

![[Pasted image 20250312144443.png]]

WannaCry process start second stage payload called `taskche.exe`

![[Pasted image 20250217223048.png]]
We can notice in the process tree view that program is been executed with `/i` parameter

```poweshell
C:\WINDOWS\tasksche.exe /i
```

![[Pasted image 20250217223206.png]]

Let's go back to **procomon** and filter by `ProcessName is taskche.exe`. 
This second stage create a folder `xjskenheabcsyb820`. This folder is the staging area of `WannaCry.exe` malware.

![[Pasted image 20250217224134.png]]


### Persistence

Under windows service i notice there is a new service called `xjskenheabcsyb820` like a staging folder.
![[Pasted image 20250217224225.png]]

I have insert this filter on Procmon
- Path contains `SYSTEM\CurrentControlSet\Services\`
- Operation is `RegCreateKey`

![[Pasted image 20250217232814.png]]

The `xjskenheabcsyb820` service execute this commad

```powershell
cmd.exe /c "C:\ProgramData\xjskenheabcsyb820\tasksche.exe"
```
