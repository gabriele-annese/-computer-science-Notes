# Intro 
WannaCry is the most famous `crypto-ransomware`. WannaCry used the famous `[Enternal Blue - CVE-2017-0144 Detail](https://en.wikipedia.org/wiki/EternalBlue)` vulnerability discovered by *National Security Agency (NSA)* stolen and made public by *Shadows Brokers*. This vulnerability target a bug in the packing handling of `SMBv1` protocol.


![[Pasted image 20250211230114.png]]






# Static Analysis
## Hashes
**md5**   : `db349b97c37d22f5ea1d1841e3c89eb4`
**sha1**  : `e889544aff85ffaf8b0d0da705105dee7c97fe26`
**sha256**: `24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c`

#### Virus Total records
[24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c](https://www.virustotal.com/gui/file/24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c)

### Architecture

The malware is written for 32-bit architecture
![[Pasted image 20250209170935.png]]


### IAT



The import address table (IAT) of WannaCry is:

| DLL Name     | Address1   | Address2   | Type     | Count | Category | Description                           |
| ------------ | ---------- | ---------- | -------- | ----- | -------- | ------------------------------------- |
| WS2_32.dll   | 0x0000A3C4 | 0x0000A144 | implicit | 13    | network  | Windows Socket Library                |
| iphlpapi.dll | 0x0000A3FC | 0x0000A17C | implicit | 2     | network  | IP Helper API                         |
| WININET.dll  | 0x0000A3B4 | 0x0000A134 | implicit | 3     | network  | Internet Extensions for Win32 Library |
| KERNEL32.dll | 0x0000A2B0 | 0x0000A030 | implicit | 32    | -        | Windows NT BASE API Client            |
| ADVAPI32.dll | 0x0000A280 | 0x0000A000 | implicit | 11    | -        | Advanced Windows 32 Base API          |
| MSVCP60.dll  | 0x0000A334 | 0x0000A0B4 | implicit | 2     | -        | Windows C Runtime Library             |
| MSVCRT.dll   | 0x0000A340 | 0x0000A0C0 | implicit | 28    | -        | Microsoft C Runtime Library           |




The `signature: executable, offset: 0x000320A4, size: 3514368 bytes` indicated that malware have inside of it another PE files.
![[Pasted image 20250212232122.png]]


we now that are ransomware infected there are `CryptGenRandom` `CryptAcquireContextA` methods of `ADVAPI32.dll` in the Import Address Table.
![[Pasted image 20250212201258.png]]


Analyzing the string i founded this path `C:\%s\qeriuwjhrf` where the `%s` will be replace by the program when executed.

With PE studio we see the malware have inside another 3 signature of the PE file, this are the possible name of then
![[Pasted image 20250212233719.png]]

I found a strange endpoint. Explore more of that in reverse engineering section.

`http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com`
![[Pasted image 20250209172055.png]]



### Reverse Engineering 

![[Pasted image 20250212235206.png]]
At a start up Wannacry call first the `[InternetOpenA](https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopena)` winApi to initialize `WinINet` function. After that the `[InternetOpenUrlA](https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopenurla)` will invoked this contact trought HTPP the strange endpoint founded during the string analysis `http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com`,
if this endpoint exists the InternetOpenUrlA return a true value.

#### KillSwitch Mode
The program is be written to close itself the InternetOpenUrlA return a true value. In a nutshell if the `http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com` endpoint exists Wannacry stop his execution.




# Dynamic Analysis

## Network Indicators

### killswitch
In this case i have activated the `InetSim` on my `Remnux` machine.

Dns Request 
`www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com`

![[Pasted image 20250211221550.png]]

Http Request respond with 200

![[Pasted image 20250211221756.png]]

In this case wannaCry doesn't execute its malicious activities and close itself. Thi is `killswitch` mechanism founded in the RE section.


### Propagation

Wannacry is `ransomware` but his have the `worm` ability.
This means its able to propagate itself using the victim network. In this case Wannacry try to propagate itself targeting the `445` port (SMB port).
![[Pasted image 20250213001927.png]]

## Host base indicator



