Malware example: `PMAT-labs\\labs\\2-5.AntiAnalysis\\1.simpleAntiAnalysis`

## Anti-analysis Techniques
The **anti-analysis** are techniques used by malware developers to make difficult the static analysis modifying the strings name or add "noise" code and dynamic analysis identifying the debug flags or if the environment is a VM or using techniques to execute the ONLY if the environment that's what expect.

Principal anti-analysis techniques in MITRE ATT&CK:

- [Virtualization/Sandbox Evasion](https://attack.mitre.org/techniques/T1497/)
- [Debugger Evasion](https://attack.mitre.org/techniques/T1622/)
- [Execution Guardrails](https://attack.mitre.org/techniques/T1480/)

## IsDebuggerPresent() API Call

In this example we explore the simple **IsDebuggerPresent** debugger evasion

The IsDebuggerPresent API call second the [Microsoft documentation](https://learn.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-isdebuggerpresent) return a **NON zero** value if the code is running in the context of a debugger and return a **zero** value if the code is not running in the context if a debugger. 

If we open the **simpleAntiAnalysis-cpp** PE file in cutter in the **WinMain** function we can notice there is a IsDebuggerPresent() call function.

![[Pasted image 20250109170151.png]]

- `IsDebuggerPresent`: First the call **IsDebuggerPresent()** return a in **AEX** register the 0 value if the context are NOT in a debugger and return 1 if the context are in a debugger.
- `test eax,eax`: In this section the program perform a bitwise **AND** of the value of **EAX** register, so if the EAX != 0 (there is a debugger) will be set the **Zero Flag (ZF)** to 0. If the EAX == 0 (there isn't a debugger) will be set the **Zero Flag (ZF)** to 1.
- `setne al`: This section of the program set in the **AL** register (the lower register of EAX) to:
	- `1` if the ZF is 0 (EAX != 0 there is a debugger)
	- `0` if the ZF if 1 (EAX == 0 there isn't a debugger)
	so now if the value of AL is 1  means there is a debugger
- `test al,al`: equals to `test eax,eax` but now the program test the value of al register set previously. 
	- AL == 1 then ZF == 0 (there is a debugger)
	- AL == 0 then ZF == 1 (there isn't a debugger)
- `je 0x1400015a9`: this section of program perform a JE (Jump if Equal) to **0x1400015a9 address if the ZF is not 0** else continue with the normal program flow.
	- if the ZF != 0 go to 0x1400015a9 (No debuggers detected)
	- if the ZF == 0 continue with the flow (Debuggers detected) 

Now if we try to execute the malware will come spawn two message box this means no debugger will be detected
![[Pasted image 20250109172858.png]]
![[Pasted image 20250109172926.png]]
![[Pasted image 20250109172929.png]]

But now try to execute the program in the **x64db**
![[Pasted image 20250109181131.png]]
we can modify the ZF value to 1 to trick the program we are not in a debugger.

![[Pasted image 20250109181304.png]]

This can be automate by the `Scylla` plugins and flag the option `BeingDebugged`
![[Pasted image 20250109181332.png]]

> Warning
> If u have Scylla installed u need disable the BeingDebugged to perform a flow when IsDebuggerPresent() is true
