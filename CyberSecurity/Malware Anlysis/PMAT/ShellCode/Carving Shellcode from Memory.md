Sample for this section:Â `PMAT-labs\labs\3-2.WhatTheShell-ShellcodeAnalysis\CarveFromMemory`

In this section we take shellcode in the memory section before the process execute that, using a debugger.

## Identify Main function without debug symbols

Binary Execute flows
```text
entrypoint => CRT (preable to run this program) => mai
```

So we need to position at the finally method return value in `eax` register.

The entrypoint have to call function, we need to enter in the latest 
![[Pasted image 20250121071538.png]]

At the bottom of this function we can notice the `dword [0x004de010]` mov in `eax`
![[Pasted image 20250121071716.png]]

The value of [0x004de010] is returned by `fcn.00401875` function and this our main function.
![[Pasted image 20250121071839.png]]Now we can rename that.
![[Pasted image 20250121072041.png]]

## Find the WinAPI
Inside of the latest call function of the main function we can find the WinAPi call.
![[Pasted image 20250121072257.png]]


## Take the shellcode payload from memory
Now we know the memory location where the `WriteProcessMemory` will be called in my case is `0x0040170a`.

Using a debugger we can set a breakpoint here `0x0040170a`
![[Pasted image 20250121072952.png]]

Second [Microsoft Documentation](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory) of `WriteProcessMemory` API the third parameter is that contains a pointer of our payload

> Microsoft Learn
> [in] `lpBuffer`
> A pointer to the buffer that contains data to be written in the address space of the specified process.

![[Pasted image 20250121073828.png]]

Now using the `follwing dump r8` to view the hex value.

![[Pasted image 20250121074438.png]]

![[Pasted image 20250121074750.png]]

Now save this in to a `.bin` file.
![[Pasted image 20250121075558.png]]

Using the `scdbg` tool we can view the windows api called by binary 
![[Pasted image 20250121074939.png]]
- `f`: Specify the file
- `-s`: Step through the program until you get to the end.

This payload are a reverse shell in `javaupdate.exe`.

## Summary
This technique is useful we the payload is encoded or encrypted because the payload will be decoded or decrypted run time and we can take it using a debugger.
