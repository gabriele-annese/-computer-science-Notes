---
tags:
  - "#yara"
  - "#malware-rules"
---
## Intro
**Yet Another Recursive Acronymous (YARA)** is a open-source rule based pattern matching tool that allows security professionals to **create custom rules for identifies and categorizing malware** and other threats based on textual or binary patterns.


## Structure
Yara rules have this structure
```yara
rule Yara_Example {
    
    meta: 
        last_updated = "2021-10-15"
        author = "PMAT"
        description = "A sample Yara rule for PMAT"

    strings:
        // Fill out identifying strings and other criteria

    condition:
        // Fill out the conditions that must be met to identify the binary
}
```


In the `meta` section we can write the metadata about yara rule, in the `string` section we can add specific string finded during the static analysis, in the end the `condition` section is where we can create the own personal condition with previously string.

Example of string section:
In my malware i find this specific string
`YOURETHEMANNOWDOG`
![[Pasted image 20250225220718.png]]
I find nim string because this malware is written in nim

![[Pasted image 20250225220954.png]]
We now the `MZ` is the magic byte in windows that indicates this a PE file, we can add some this in own `strings` section
![[Pasted image 20250225221125.png]]

Its possible insert some strange hex strings for example `FF E4 ?? 00 FF` where `??` is a Wildcart.

This is the yara rule with string section:
```yara
rule Yara_Example {
    
    meta: 
        last_updated = "2021-10-15"
        author = "PMAT"
        description = "A sample Yara rule for PMAT"

    strings:
        // Fill out identifying strings and other criteria
		$String1 = "YOURETHEMANNOWDOG"
        $String2 = "nim"
        $PE_magic_byte = "MZ"
        $strange_hex_string = {FF E4 ?? 00 FF}
    condition:
        // Fill out the conditions that must be met to identify the binary
}
```

Now its time to crate a condition section, if we want the PE_magic_byte stand in the 0 position of bytes we can add 
`PE_magic_byte at 0`, to concatenate the conditions we use `and` `or` statement.

This is the yara rule after i have created the condition statement

```yara
rule Yara_Example {
    
    meta: 
        last_updated = "2021-10-15"
        author = "PMAT"
        description = "A sample Yara rule for PMAT"

    strings:
        // Fill out identifying strings and other criteria
		$String1 = "YOURETHEMANNOWDOG"
        $String2 = "nim"
        $PE_magic_byte = "MZ"
        $strange_hex_string = {FF E4 ?? 00 FF}
    condition:
        // Fill out the conditions that must be met to identify the binary
        $PE_magic_byte at 0 and
        ($String1 and $String2) or 
        $strange_hex_string
}

```
## How to use

Cool but now how can i use this rule on my malware?

Its to possible invoke the created rule with this command
```bash
 yara.exe .\yara_template.yara Malware.yara1.exe.malz  -w -p 32
```

where `yara_template.yara` its the file contains own rules. The `Malware.yara1.exe.malz` is the PE file that we want analyze, `-w` stand for *no-warnings* , `-p` indicated the number of thread we want use.
![[Pasted image 20250226210830.png]]

#### Strings

Its possible identify in the malware the strings match written in the rule. This is possible with `-s` flag
```bash
yara.exe .\yara_template.yara Malware.yara1.exe.malz -s -w -p 32
```

![[Pasted image 20250226210951.png]]


#### Recursive
Its also possible use the `-r` flag to perform a recursive scan. This means if i have 6 PE file on my desktop with this flag can i able to analyze all of this PE with my rules template

```bash
yara.exe .\yara_template.yara -r C:\Users\BusySec\Desktop\test_dir\ -w -p 32
```

![[Pasted image 20250226211450.png]]
